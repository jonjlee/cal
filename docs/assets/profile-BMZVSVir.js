import{g as i,j as d,I as l}from"./db-gBYaOoHZ.js";import{A as c}from"./auth-C9VuaBf4.js";class w{constructor(){this.auth=new c("profile.html",window.location.search).auth,this.profile=null,this.isDirty=!1}async fetchData(e){var r;if(!e.user||e.deptId==null)throw new Error(`Unable to fetch due to invalid user and department ${(r=e.user)==null?void 0:r.id}, ${e.deptId}`);const s=i(e.deptId);return Promise.all([s]).then(async t=>{if(s.error)throw new Error(`Error fetching data: ${[s.error]}`);return{auth:e,dept:t[0].data}})}renderHeader(e,s){var r;!e||!e.email?userNameLabel.innerText="Not logged in":(r=e.user_metadata)!=null&&r.restricted?userNameLabel.innerText="View Only":userNameLabel.innerText=e.email,s&&(deptNameLabel.href="./cal.html?d="+s)}initUI({auth:e,dept:s}){if(!e||!s)throw new Error("Invalid login or user data");[this.auth,this.dept]=[e,s],[window.AUTH,window.DEPT]=[e,s],this.renderHeader(e.user,s.id),userEmail.innerText=e.user.email,s.id&&(settingsLink.href="./settings.html?d="+s.id,settingsLink.classList.remove("d-none")),loadingDiv.classList.add("d-none"),profileDiv.classList.remove("d-none"),logout.addEventListener("click",this._handleLogout.bind(this)),passwordForm.addEventListener("submit",this._handlePasswordUpdate.bind(this))}async _handleLogout(e){e.preventDefault(),await d.signOut(),window.location.href="./login.html"}async _handlePasswordUpdate(e){e.preventDefault();const s=currentPassword.value,r=newPassword.value,t=confirmPassword.value;if(!s||!r||!t){passwordError.innerText="Please fill out all fields.",passwordError.classList.remove("d-none"),passwordSuccess.classList.add("d-none");return}if(r!==t){passwordError.innerText="New passwords do not match.",passwordError.classList.remove("d-none"),passwordSuccess.classList.add("d-none");return}try{const{error:n}=await l(s,r);if(n)throw n;passwordSuccess.innerText="Password updated successfully.",passwordSuccess.classList.remove("d-none"),passwordError.classList.add("d-none"),currentPassword.value="",newPassword.value="",confirmPassword.value=""}catch(n){passwordError.innerText=`${(n==null?void 0:n.message)??"Error updating password"}`,passwordError.classList.remove("d-none"),passwordSuccess.classList.add("d-none")}}}const o=window.APP=new w;document.addEventListener("DOMContentLoaded",()=>{o.auth.then(a=>o.fetchData(a).then(e=>o.initUI(e)).catch(e=>{console.log(e),loadingText.innerText="Error loading Profile. Please refresh page to try again."})).catch(a=>{console.log(a),window.location.href=o.auth.redirect})});
